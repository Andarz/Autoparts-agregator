{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-column justify-content-center align-items-center" style="min-height: 80vh;">

    <div class="main-container text-center w-100 p-5 shadow-lg" style="max-width: 700px; background: white; border-radius: 20px;">
        
        <div class="mb-4 display-1">üöô</div>
        <h2 class="mb-4 fw-bold text-secondary">–ü–æ–∏—Å–∫ –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π</h2>
        
        <form action="/search" method="post" onsubmit="saveSearchTerm()">
            <div class="input-group input-group-lg mb-4 shadow-sm">
                <input type="text" 
                       id="searchInput"
                       name="part_code" 
                       class="form-control border-secondary-subtle" 
                       placeholder="–ß—Ç–æ –∏—â–µ–º? –ù–æ–º–µ—Ä –¥–∞–≤–∞–π..." 
                       list="historyOptions" 
                       autocomplete="off"
                       required autofocus>
                
                <datalist id="historyOptions"></datalist>

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
                <button class="btn btn-primary px-4 fw-bold" type="submit">–ù–ê–ô–¢–ò</button>
                
                <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê GOOGLE -->
                <!-- type="button" –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É -->
                <button class="btn btn-outline-danger px-3 fw-bold" type="button" onclick="openGoogleSearch()" title="–ò—Å–∫–∞—Ç—å –≤ Google (–õ–∞—Ç–≤–∏—è)">
                    G
                </button>
            </div>
            
            <div class="text-muted small">
                ‚ö° –ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥–∞–º: <span class="badge bg-light text-dark border">InterCars</span> <span class="badge bg-light text-dark border">–ú–µ—Å—Ç–Ω—ã–µ</span>
            </div>
        </form>

    </div>

</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø GOOGLE -->
<div class="modal fade" id="googleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
            <span class="text-danger fw-bold">G</span> –ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ç–∏ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body bg-light" style="min-height: 300px;">
        
        <!-- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="googleLoader" class="text-center mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">–û–ø—Ä–∞—à–∏–≤–∞–µ–º Google...</p>
        </div>

        <!-- –°—é–¥–∞ —É–ø–∞–¥—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="googleResults" class="list-group"></div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // –ò–°–¢–û–†–ò–Ø –ü–û–ò–°–ö–ê
    const STORAGE_KEY = 'autoparts_search_history';

    document.addEventListener("DOMContentLoaded", function() {
        const input = document.getElementById('searchInput');
        const dataList = document.getElementById('historyOptions');
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        history.forEach(term => {
            let option = document.createElement('option');
            option.value = term;
            dataList.appendChild(option);
        });
    });

    function saveSearchTerm() {
        const input = document.getElementById('searchInput');
        const term = input.value.trim();
        if (!term) return;
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        history = history.filter(item => item !== term);
        history.unshift(term);
        if (history.length > 10) history = history.slice(0, 10);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê GOOGLE ---
    function openGoogleSearch() {
        const input = document.getElementById('searchInput');
        const query = input.value.trim();
        
        if (!query) {
            alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–µ—Ç–∞–ª–∏!");
            input.focus();
            return;
        }

        // 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
        var myModal = new bootstrap.Modal(document.getElementById('googleModal'));
        myModal.show();

        // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä, —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä–æ–µ
        document.getElementById('googleLoader').style.display = 'block';
        document.getElementById('googleResults').innerHTML = '';

        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä
        fetch(`/google-search-api?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultsDiv = document.getElementById('googleResults');
                document.getElementById('googleLoader').style.display = 'none';

                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="alert alert-warning">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ Google.</div>';
                    return;
                }

                // 4. –†–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫
                data.results.forEach(item => {
                    const link = document.createElement('a');
                    link.href = item.link;
                    link.target = "_blank"; // –û—Ç–∫—Ä—ã–≤–∞—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                    link.className = "list-group-item list-group-item-action p-3 mb-2 rounded border shadow-sm";
                    
                    link.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 text-primary fw-bold text-decoration-underline">${item.title}</h6>
                        </div>
                        <p class="mb-1 small text-muted">${item.desc}</p>
                        <small class="text-success">${new URL(item.link).hostname}</small>
                    `;
                    resultsDiv.appendChild(link);
                });
            })
            .catch(err => {
                console.error(err);
                document.getElementById('googleLoader').style.display = 'none';
                document.getElementById('googleResults').innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞.</div>';
            });
    }
</script>
{% endblock %}